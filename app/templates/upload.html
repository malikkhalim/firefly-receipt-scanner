{% extends "base.html" %}

{% block title %}Upload Receipt{% endblock %}

{% block content %}
<div class="text-center mb-8">
    <h1 class="text-3xl font-bold text-slate-100 tracking-tight">Receipt Scanner</h1>
    <p class="text-slate-400 mt-2">Upload your receipt to begin extraction.</p>
</div>

<form id="receipt-form" action="/extract" method="post" enctype="multipart/form-data" onsubmit="return showLoading();">

    {% if success_message %}
    <div class="flex items-center p-4 mb-4 text-sm text-green-300 border border-green-700 rounded-lg bg-green-900/50"
        role="alert">
        <svg class="flex-shrink-0 inline w-4 h-4 mr-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 14.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM10 10a1 1 0 1 1-2 0V6a1 1 0 1 1 2 0v4Z">
            </path>
        </svg>
        <span class="font-medium">{{ success_message }}</span>
    </div>
    {% endif %}

    <div class="space-y-6">
        <div>
            <label for="source_account" class="block text-sm font-medium text-slate-300 mb-1">Source Account</label>
            <select id="source_account" name="source_account" required
                class="w-full bg-slate-900/80 border border-slate-700 text-slate-200 text-sm rounded-lg focus:ring-brand-indigo-500 focus:border-brand-indigo-500 block p-2.5 transition">
                {% for account in asset_accounts %}
                <option value="{{ account }}">{{ account }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="upload-area" class="p-6 border-2 border-slate-700 border-dashed rounded-lg bg-slate-900/50">
            <div id="initial-state">
                <p class="text-center text-sm text-slate-400 mb-4">Choose an upload method:</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button type="button" id="camera-btn"
                        class="flex-1 inline-flex items-center justify-center px-4 py-3 text-sm font-medium text-white bg-slate-800 border border-slate-700 rounded-md hover:bg-slate-700 transition">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008v-.008z" />
                        </svg>
                        Take Photo
                    </button>
                    <button type="button" id="gallery-btn"
                        class="flex-1 inline-flex items-center justify-center px-4 py-3 text-sm font-medium text-white bg-slate-800 border border-slate-700 rounded-md hover:bg-slate-700 transition">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                        </svg>
                        Upload from Gallery
                    </button>
                </div>
            </div>
            <div id="file-name-display" class="hidden flex items-center justify-center text-center">
                <svg class="w-6 h-6 mr-2 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p id="file-info" class="font-medium text-slate-300"></p>
                <p class="text-xs text-slate-500 mt-1 absolute bottom-2 left-1/2 -translate-x-1/2">Click a button above
                    to replace</p>
            </div>
            <input type="file" id="file" name="file" accept="image/*" class="hidden">
        </div>
    </div>

    <div class="mt-8">
        <button type="submit" id="submit-btn"
            class="w-full text-white bg-brand-indigo-600 hover:bg-brand-indigo-700 focus:ring-4 focus:outline-none focus:ring-brand-indigo-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition-all duration-300 shadow-lg hover:shadow-brand-indigo-800/50">
            Extract Receipt Data
        </button>
    </div>
</form>

<div id="loading" class="hidden mt-6 text-center">
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function showLoading() {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('receipt-form').classList.add('hidden');
    }

    const fileInput = document.getElementById('file');
    const cameraBtn = document.getElementById('camera-btn');
    const galleryBtn = document.getElementById('gallery-btn');

    const initialState = document.getElementById('initial-state');
    const fileNameDisplay = document.getElementById('file-name-display');
    const fileInfo = document.getElementById('file-info');

    // Fungsi untuk mengupdate UI setelah file dipilih
    function updateFileDisplay(file) {
        if (file) {
            // Sembunyikan tombol-tombol dan tampilkan nama file
            initialState.classList.add('hidden');
            fileNameDisplay.classList.remove('hidden');
            fileInfo.textContent = file.name;
        }
    }

    // --- SCRIPT BARU UNTUK KONTROL TOMBOL ---

    // Saat tombol "Take Photo" diklik
    cameraBtn.addEventListener('click', () => {
        // Tambahkan atribut 'capture' untuk langsung buka kamera
        fileInput.setAttribute('capture', 'environment');
        fileInput.click();
    });

    // Saat tombol "Upload from Gallery" diklik
    galleryBtn.addEventListener('click', () => {
        // Hapus atribut 'capture' agar membuka galeri
        fileInput.removeAttribute('capture');
        fileInput.click();
    });

    // Event listener untuk saat file dipilih (baik dari kamera maupun galeri)
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            updateFileDisplay(e.target.files[0]);
        }
    });

</script>
{% endblock %}